## TCP/IP

### ARP

- `OSI`模型将网络分为七层，`IP`地址在第三层的网络层，`MAC`地址（物理地址）在第二层的链路层，彼此不直接打交道。在通过以太网发送`IP`数据包时，需要先在`OSI`模型中从上到下的封装网络层和链路层的报头，但由于发送时只知道目标`IP`地址，不知道其`MAC`地址，又不能跨二、三层直接发送数据包，所以就需要一个地址解析协议来获得相应`IP`地址的`MAC`地址
- `ARP(Address Resolution Protocol)`，地址解析协议，功能是根据`IP`地址获取`MAC`地址
- 主机发送信息时会将包含目标`IP`地址的`ARP`请求广播到局域网络上的所有主机，并接收返回消息，以此确定目标`IP`的物理地址
- `ARP`欺骗：`ARP`协议是建立在网络中的各个主机互相信任的基础上的，局域网络上的主机可以自主发送`ARP`应答消息，其他主机收到应答报文时并不会检测该报文的真实性就直接将其记入本机的`ARP`缓存，这就构成了一个`ARP`欺骗

### IP 数据报

- `TCP/IP`协议定义了一个在因特网上传输的包，称为`IP`数据报，由首部和数据两部分组成

### MTU

- `MTU(Maximum Transmission Unit)`，最大传输单元，是包或帧的最大长度，是链路层的概念
- `MTU`过大，路由器会拒绝转发，因为路由器不能处理过大的包；过小也划不来，因为协议一定要在数据包上加上包头，那么实际传输的数据量就更小了
- 如果`IP`层有一个数据报要传，并且数据帧的长度比链路层的`MTU`还大，那么`IP`层就需要对数据报进行分片处理，将数据报分成若干片，每片小于`MTU`

### TCP

#### - 报文结构

![image-20210409094727970](..\assets\statics\TCP报文结构.png)

- `TCP`的报文头有`20`个字节的基础报文头信息和一个可选项字段（长度必须是`32 bits`的整数倍）
- 在`TCP`的基础报文头信息中，字段从上到下表示的含义如下：
  - 源端口和目的端口字段（`4`字节`32`位）：用于标识`TCP`源端口号（低`16`位）和目的端口号（高`16`位）
  - 序列号字段（`seq`，`4`字节`32`位）：表示本报文段所发送数据的第一个字节的编号
  - 确认号字段（`ack`，`4`字节`32`位）：`TCP`确认号，表示接收方期望收到发送方下一个报文段的第一个字节数据的编号
  - 第四层字段由四部分组成：
    - 数据偏移字段（`4`比特）：`TCP`首部长度，标识数据段中的数据部分起始地址距离`TCP`数据段起始地址处的字节偏移量
    - 保留字段（`6`比特）：为`TCP`未来的发展预留空间，目前全部置`0`
    - 标志位字段（`6`比特）：
      - `URG`：标识本报文段中发送的数据是否包含紧急数据
        - `URG = 1`时表示有紧急数据
        - 只有当`URG = 1`时，后面的紧急指针字段才有效
      - `ACK`：标识前面的确认号字段是否有效
        - `ACK = 1`时表示有效，且只有当`ACK = 1`时，前面的确认号字段才有效
        - `TCP`规定，连接建立后，`ACK`必须为`1`
      - `PSH`：告诉对方收到该报文段后是否立即把数据推送给上层
        - 如果`PSH = 1`，表示应当立即把数据提交给上层，而不是缓存起来
      - `RST`：标识是否重置连接
        - 如果`RST = 1`，说明`TCP`连接出现了严重错误（如主机崩溃），必须释放连接，然后再重新建立连接
      - `SYN`：在建立连接时使用，用来同步序号
        - 当`SYN = 1, ACK = 0`时，表示这是一个请求建立连接的报文段
        - 当`SYN = 1, ACK = 1` 时，表示对方同意建立连接
      - `FIN`：标记数据是否发送完毕
        - 如果`FIN = 1`，表示数据已经发送完成，可以释放连接
    - 窗口大小字段（`16`比特）：表示从`Acknowledgment Number`开始还可以接收多少字节的数据量，也表示当前接收端的接收窗口还有多少剩余空间。该字段可以用于`TCP`的流量控制
  - 第五层字段由两部分组成：
    - `TCP`校验和字段（低`16`位）：`TCP Checksum`，用于确认传输的数据是否有损坏
      - 发送端基于数据内容校验生成一个数值，接收端根据接收到的数据校验生成一个数值，这两个数值必须相同，才能证明数据是有效地，如果不同，就直接丢掉这个数据包
      - `Checksum`是根据 `伪头 + TCP头 + TCP数据`三部分进行计算的
    - 紧急指针字段（高`16`位）：仅当前面的`URG`标志位为`1`时才有意义，它表示本数据段中为紧急数据的字节数
  - 可选项字段：`Options`，长度不定，但必须是`32 bits`的整数倍
  - http://c.biancheng.net/view/6380.html

