## TCP/IP

### ARP

- `OSI`模型将网络分为七层，`IP`地址在第三层的网络层，`MAC`地址（物理地址）在第二层的链路层，彼此不直接打交道。在通过以太网发送`IP`数据包时，需要先在`OSI`模型中从上到下的封装网络层和链路层的报头，但由于发送时只知道目标`IP`地址，不知道其`MAC`地址，又不能跨二、三层直接发送数据包，所以就需要一个地址解析协议来获得相应`IP`地址的`MAC`地址
- `ARP(Address Resolution Protocol)`，地址解析协议，功能是根据`IP`地址获取`MAC`地址
- 主机发送信息时会将包含目标`IP`地址的`ARP`请求广播到局域网络上的所有主机，并接收返回消息，以此确定目标`IP`的物理地址
- `ARP`欺骗：`ARP`协议是建立在网络中的各个主机互相信任的基础上的，局域网络上的主机可以自主发送`ARP`应答消息，其他主机收到应答报文时并不会检测该报文的真实性就直接将其记入本机的`ARP`缓存，这就构成了一个`ARP`欺骗

### IP 数据报

- `TCP/IP`协议定义了一个在因特网上传输的包，称为`IP`数据报，由首部和数据两部分组成

### MTU

- `MTU(Maximum Transmission Unit)`，最大传输单元，是包或帧的最大长度，是链路层的概念
- `MTU`过大，路由器会拒绝转发，因为路由器不能处理过大的包；过小也划不来，因为协议一定要在数据包上加上包头，那么实际传输的数据量就更小了
- 如果`IP`层有一个数据报要传，并且数据帧的长度比链路层的`MTU`还大，那么`IP`层就需要对数据报进行分片处理，将数据报分成若干片，每片小于`MTU`

### TCP

#### - 报文结构

![image-20210409094727970](..\assets\statics\TCP报文结构.png)

- **`TCP`的报文头有`20`个字节的基础报文头信息和一个可选项字段（长度必须是`32 bits`的整数倍）**
- 在`TCP`的基础报文头信息中，**字段从上到下每`4`个字节为一层**表示的含义如下：
  1. 源端口和目的端口字段（`4`字节`32`位）：

     - 用于标识`TCP`源端口号（低`16`位）和目的端口号（高`16`位）
  2. 序列号字段（`seq`，`4`字节`32`位）：

     - 表示本报文段所发送数据的第一个字节的编号
  3. 确认号字段（`ack`，`4`字节`32`位）：

     - `TCP`确认号，表示接收方期望收到发送方下一个报文段的第一个字节数据的编号
  4. 第四层字段由四部分组成：

     1. 数据偏移字段（`4`比特）：

        - `TCP`首部长度，标识数据段中的数据部分起始地址距离`TCP`数据段起始地址处的字节偏移量
     2. 保留字段（`6`比特）：

        - 为`TCP`未来的发展预留空间，目前全部置`0`
     3. 标志位字段（`6`比特）：

        1. `URG`：标识本报文段中发送的数据是否包含紧急数据

           - `URG = 1`时表示有紧急数据

           - 只有当`URG = 1`时，后面的紧急指针字段才有效
        2. `ACK`：标识前面的确认号字段是否有效

           - `ACK = 1`时表示有效，且只有当`ACK = 1`时，前面的确认号字段才有效

           - `TCP`规定，连接建立后，`ACK`必须为`1`
        3. `PSH`：告诉对方收到该报文段后是否立即把数据推送给上层
           - 如果`PSH = 1`，表示应当立即把数据提交给上层，而不是缓存起来
        4. `RST`：标识是否重置连接
           - 如果`RST = 1`，说明`TCP`连接出现了严重错误（如主机崩溃），必须释放连接，然后再重新建立连接
        5. `SYN`：在建立连接时使用，用来同步序号
           - 当`SYN = 1, ACK = 0`时，表示这是一个请求建立连接的报文段
           - 当`SYN = 1, ACK = 1` 时，表示对方同意建立连接
        6. `FIN`：标记数据是否发送完毕
           - 如果`FIN = 1`，表示数据已经发送完成，可以释放连接
     4. 窗口大小字段（`16`比特）：
        - 表示从`Acknowledgment Number`开始还可以接收多少字节的数据量，也表示当前接收端的接收窗口还有多少剩余空间。该字段可以用于`TCP`的流量控制
  5. 第五层字段由两部分组成：
     1. `TCP`校验和字段（低`16`位）：`TCP Checksum`，用于确认传输的数据是否有损坏
        - 发送端基于数据内容校验生成一个数值，接收端根据接收到的数据校验生成一个数值，这两个数值必须相同，才能证明数据是有效地，如果不同，就直接丢掉这个数据报
        - `Checksum`是根据 `伪首部 + TCP报头 + TCP数据`三部分进行计算的
     2. 紧急指针字段（高`16`位）：仅当前面的`URG`标志位为`1`时才有意义，它表示本数据段中为紧急数据的字节数
  6. 可选项字段：`Options`，长度不定，但必须是`32 bits`的整数倍

#### - 可靠传输

- `TCP`主要提供了校验和、确认应答、超时重传、最大消息长度、滑动窗口、拥塞控制等方法去实现可靠传输
- 校验和：
  - `TCP Checksum`由伪首部、`TCP`报头、`TCP`数据三部分组成
  - 校验和先由发送端计算，再由接收端验证。如果接收端检测到校验和有差错，就会直接丢掉这个数据报
  - 一些区别：
    - `TCP`校验和覆盖了`TCP`首部和`TCP`数据，而`IP`首部中的校验和只覆盖`IP`的首部，不覆盖`IP`数据报中的任何数据
    - `TCP`的校验和是必需的，而`UDP`的校验和是可选的
    - `TCP`和`UDP`计算校验和时，都要加上一个`12`字节的伪首部
- 确认应答：
  - 发送端发送数据报后，接收端没有回应确认包（`ACK`包），或者接收端发送的确认包，发送端没有收到，都会引起数据发送端的数据重发
- 超时重传：
  - 由发送端发送一个数据报，到接收端接收到数据报，再由接收端发送一个应答确认包，到发送端接收到这个应答确认包。这样的一个发送与应答的往返时间，称为`RTT`
  - 由于网络原因的问题，`RTT`与理想值之间可能有偏差，称为抖动（方差）
  - 超时重传的触发时间大概是比`RTT`+ 抖动 还要稍大的时间
  - 如果在重发过程中，一个数据报经过多次重发也没有收到对方的应答确认包，那么就会认为对方接收异常，强制关闭连接，并且通知应用通信异常、强行终止
- 最大消息长度：
  - 在建立`TCP`连接的时候，双方约定一个最大的长度`MSS(Maximum Segment Size)`作为发送的单位，重传的时候也是以这个单位来进行重传
  - 理想的情况下，`MSS`的数据刚好不会被网络层分块
- 滑动窗口：
  - 超时重传的机制存在效率低下的问题，因为需要等待对方的应答后才能发送下一个数据报；滑动窗口就是一个不用等待应答确认包就能发送下一个数据报的机制
  - 窗口的大小就是在无需等待确认包的情况下，发送端还能发送的最大数据量
  - 在窗口之外的数据就是还未发送的和对端已经接收到的数据
  - 当接收端在没有收到自己所期望的应答确认包之前，会对之前的数据进行重复确认；如果发送端在收到某个应答包之后，又连续`3`次收到同样的应答包，则说明数据已经丢失，需要重发
- 拥塞控制：
  - 

#### - TCP 伪首部

- 伪首部共有`12`个字节，包含如下信息：源`IP`地址、目的`IP`地址、保留字节（置`0`）、传输层协议号（`TCP`是`6`）、`TCP`报文长度（报头 + 数据）

- 伪首部是为了增加`TCP`校验和的检错能力，比如通过目的`IP`地址检查`TCP`报文是否收错了、通过传输层协议号检查传输层协议是否选对了等

  ![image-20210420100849169](..\assets\statics\TCP伪首部.jpg)

- 

---

## 参考

- https://zhuanlan.zhihu.com/p/112317245

- [C语言中文网 - TCP/IP](http://c.biancheng.net/view/6380.html)